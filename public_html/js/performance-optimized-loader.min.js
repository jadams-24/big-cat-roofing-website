class PerformanceOptimizer{constructor(){this.loadedScripts=new Set,this.pendingLoads=new Map,this.init()}init(){this.setupIntersectionObserver(),this.setupEventListeners(),this.setupDelayedLoaders()}loadPopupModal(){return this.loadedScripts.has("popup-modal")?Promise.resolve():this.pendingLoads.has("popup-modal")?this.pendingLoads.get("popup-modal"):(this.pendingLoads.set("popup-modal",this.loadScript("js/popup-modal.min.js","popup-modal").then(()=>this.loadStylesheet("css/popup-modal.min.css","popup-modal-css"))),this.pendingLoads.get("popup-modal"))}loadServiceAreaMap(){return this.loadedScripts.has("service-area-map")?Promise.resolve():this.pendingLoads.has("service-area-map")?this.pendingLoads.get("service-area-map"):(this.pendingLoads.set("service-area-map",this.loadStylesheet("https://unpkg.com/leaflet@1.9.4/dist/leaflet.css","leaflet-css").then(()=>this.loadScript("https://unpkg.com/leaflet@1.9.4/dist/leaflet.js","leaflet")).then(()=>this.loadScript("js/service-area-map.min.js","service-area-map"))),this.pendingLoads.get("service-area-map"))}loadEmailNotifications(){return this.loadedScripts.has("email-notifications")?Promise.resolve():this.pendingLoads.has("email-notifications")?this.pendingLoads.get("email-notifications"):(this.pendingLoads.set("email-notifications",this.loadScript("js/email-notifications.min.js","email-notifications")),this.pendingLoads.get("email-notifications"))}loadScript(e,t){return new Promise((s,i)=>{if(this.loadedScripts.has(t))return void s();const a=document.createElement("script");a.src=e,a.async=!0,a.defer=!0,a.onload=()=>{this.loadedScripts.add(t),s()},a.onerror=()=>{console.warn(`Failed to load script: ${e}`),i(new Error(`Script load failed: ${e}`))},document.head.appendChild(a)})}loadStylesheet(e,t){return new Promise((s,i)=>{if(this.loadedScripts.has(t))return void s();const a=document.createElement("link");a.rel="stylesheet",a.href=e,a.onload=()=>{this.loadedScripts.add(t),s()},a.onerror=()=>{console.warn(`Failed to load stylesheet: ${e}`),i(new Error(`Stylesheet load failed: ${e}`))},document.head.appendChild(a)})}setupIntersectionObserver(){"IntersectionObserver"in window&&new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target;("service-area-map"===t.id||"homepage-service-map"===t.id)&&(this.loadServiceAreaMap(),observer.unobserve(t))}})},{rootMargin:"50px"}).observe(document.querySelectorAll("#service-area-map, #homepage-service-map"))}setupEventListeners(){document.querySelectorAll('[href*="estimate"], .estimate-btn, .cta-button, .free-estimate').forEach(e=>{let t;e.addEventListener("mouseenter",()=>{clearTimeout(t),t=setTimeout(()=>this.loadPopupModal(),100)},{passive:!0,once:!0}),e.addEventListener("focus",()=>this.loadPopupModal(),{passive:!0,once:!0}),e.addEventListener("click",e=>{this.loadPopupModal()},{passive:!0})}),document.querySelectorAll('form[action*="formspree"], .contact-form, #contact-form').forEach(e=>{const t=e.querySelector("input, textarea, select");t&&t.addEventListener("focus",()=>this.loadEmailNotifications(),{passive:!0,once:!0})})}setupDelayedLoaders(){window.addEventListener("load",()=>{setTimeout(()=>{document.querySelectorAll('[href*="estimate"], .estimate-btn').length>0&&setTimeout(()=>this.loadPopupModal(),3e3)},1e3)},{passive:!0});let e=!1;const t=()=>{!e&&window.pageYOffset>100&&(e=!0,this.loadPopupModal(),window.removeEventListener("scroll",t))};window.addEventListener("scroll",t,{passive:!0})}prefetchOnIdle(){"requestIdleCallback"in window&&requestIdleCallback(()=>["js/popup-modal.min.js","css/popup-modal.min.css"].forEach(e=>{const t=document.createElement("link");t.rel="prefetch",t.href=e,document.head.appendChild(t)}))}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.performanceOptimizer=new PerformanceOptimizer}):window.performanceOptimizer=new PerformanceOptimizer,window.loadPopupModal=()=>window.performanceOptimizer?.loadPopupModal(),window.loadServiceAreaMap=()=>window.performanceOptimizer?.loadServiceAreaMap(),window.loadEmailNotifications=()=>window.performanceOptimizer?.loadEmailNotifications();